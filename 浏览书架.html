<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥é˜… - æˆ‘çš„ä¹¦æ¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', "Microsoft YaHei", sans-serif; background-color: #f8fafc; }
        .sidebar-active { background-color: #ebf5ff; border-right: 4px solid #3b82f6; color: #1e40af; }
        
        /* é€‰ä¸­çŠ¶æ€æ ·å¼ */
        .book-card.selected .book-cover { border: 4px solid #3b82f6; transform: scale(0.95); }
        .book-card.selected .checkbox-wrapper { background-color: #3b82f6; border-color: #3b82f6; color: white; }

        .book-cover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .book-card:not(.selected):hover .book-cover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<div id="addBookModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-[24px] w-full max-w-md p-8 shadow-2xl border border-slate-100">
        <h2 class="text-xl font-bold text-slate-800 mb-6">å¯¼å…¥ä¹¦ç±</h2>
        <div class="space-y-4">
            <input type="text" id="newTitle" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500/20" placeholder="ä¹¦å">
            <input type="text" id="newAuthor" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500/20" placeholder="ä½œè€… (å¯é€‰)">
            <div class="border-2 border-dashed border-slate-100 rounded-2xl p-8 text-center relative hover:bg-slate-50 transition-colors cursor-pointer">
                <input type="file" id="fileInput" accept=".epub,.pdf,.txt" class="absolute inset-0 opacity-0 cursor-pointer">
                <div id="fileStatus" class="text-xs text-slate-400">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl mb-3 text-blue-200"></i>
                    <p>ç‚¹å‡»é€‰æ‹© EPUB, PDF æˆ– TXT</p>
                </div>
            </div>
        </div>
        <div id="progressContainer" class="hidden mt-4">
            <div class="flex justify-between mb-1">
                <span id="progressText" class="text-[10px] font-bold text-blue-600">å‡†å¤‡ä¸­...</span>
                <span id="progressPercent" class="text-[10px] font-bold text-blue-600">0%</span>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                <div id="progressInner" class="bg-blue-600 h-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
        <div class="flex gap-3 mt-8">
            <button onclick="closeModal()" class="flex-1 py-3 text-sm font-bold text-slate-400 hover:bg-slate-50 rounded-xl">å–æ¶ˆ</button>
            <button id="uploadBtn" class="flex-1 py-3 bg-blue-600 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-all">å¼€å§‹è§£æ</button>
        </div>
    </div>
</div>
<body class="flex min-h-screen text-slate-700">

    <!-- ä¾§è¾¹å¯¼èˆªæ  -->
    <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col sticky top-0 h-screen shrink-0">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-lg">çŸ¥</div>
            <span class="text-xl font-bold text-slate-800">çŸ¥é˜…</span>
        </div>
        <nav class="flex-1 px-4 space-y-1">
            <a href="strict-merge-dashboard.html" class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-md transition-all">
                <i class="fa-solid fa-house text-sm"></i><span class="font-medium text-sm">é¦–é¡µä»ªè¡¨ç›˜</span>
            </a>
            <a href="é˜…è¯»ç›®æ ‡åˆ—è¡¨é¡µ.html" class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-md transition-all">
                <i class="fa-solid fa-bullseye text-sm"></i><span class="text-sm">é˜…è¯»ç›®æ ‡</span>
            </a>
            <a href="é˜…è¯»é¡¹ç›®åˆ—è¡¨é¡µ.html" class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-md transition-all">
                <i class="fa-regular fa-folder text-sm"></i><span class="text-sm">é˜…è¯»é¡¹ç›®</span>
            </a>
            <a href="æµè§ˆä¹¦æ¶.html" class="sidebar-active flex items-center gap-3 px-4 py-3 rounded-md transition-all">
                <i class="fa-solid fa-book-open text-sm"></i><span class="font-medium text-sm">æˆ‘çš„ä¹¦æ¶</span>
            </a>
            <a href="è¯»ä¹¦ç¬”è®°åˆ—è¡¨é¡µ.html" class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-md transition-all">
                <i class="fa-solid fa-pen-to-square text-sm"></i><span class="text-sm">è¯»ä¹¦ç¬”è®°</span>
            </a>
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto" id="mainContent">
        <div class="w-full max-w-[1600px] mx-auto p-6 md:p-10 pb-40 pt-24">
            <header class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-12">
                <div>
                    <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight" id="pageTitle">æˆ‘çš„ä¹¦æ¶</h1>
                    <p class="text-slate-500 mt-2" id="pageDesc">ç‚¹å‡»ä¹¦ç±å°é¢è¿›å…¥é˜…è¯»æ¨¡å¼</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="relative group">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                        <input type="text" id="searchInput" placeholder="æœç´¢ä¹¦å..." 
                               class="pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 w-full md:w-80 shadow-sm transition-all">
                    </div>
                </div>
            </header>

            <div id="bookGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-x-8 gap-y-12">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </main>

    <!-- å¯¼å…¥å·¥å…·æ  (ä»…åœ¨ mode=select æ—¶æ ¹æ®é€‰ä¸­æƒ…å†µæ˜¾ç¤º) -->
    <div id="batchToolbar" class="fixed bottom-0 left-0 right-0 md:left-64 bg-white border-t border-slate-200 p-5 shadow-[0_-10px_30px_rgba(0,0,0,0.08)] transform translate-y-full z-50 transition-transform duration-300">
        <div class="max-w-[1600px] mx-auto flex items-center justify-between px-6">
            <div class="flex flex-col">
                <span class="text-sm font-bold text-slate-900 leading-none">å·²é€‰ä¸­ <span id="selectedCount" class="text-blue-600">0</span> æœ¬ä¹¦ç±</span>
                <button onclick="clearAllSelection()" class="text-[11px] text-slate-400 hover:text-rose-500 font-medium mt-1 transition-colors text-left">å–æ¶ˆå…¨éƒ¨é€‰æ‹©</button>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="window.history.back()" class="px-6 py-2.5 text-slate-600 hover:bg-slate-50 rounded-xl text-sm font-bold border border-slate-200">å–æ¶ˆ</button>
                <button id="confirmBtn" onclick="confirmImport()" class="px-8 py-2.5 bg-blue-600 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-all">
                    ç¡®è®¤å¯¼å…¥åˆ°é¡¹ç›®
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabase-config.js';
    
        let allBooks = [];
        let selectedIds = [];

    
        const urlParams = new URLSearchParams(window.location.search);
        const isSelectMode = urlParams.get('mode') === 'select';
    
        function initUI() {
            if (isSelectMode) {
                document.getElementById('pageTitle').innerText = "é€‰æ‹©ä¹¦ç±";
                document.getElementById('pageDesc').innerText = "å‹¾é€‰éœ€è¦æ·»åŠ åˆ°æ–°é¡¹ç›®çš„ä¹¦ç±";
            }
        }
    
        async function fetchBooks() {
            const { data, error } = await supabase.from('books').select('*').order('created_at', { ascending: false });
            if (!error) {
                allBooks = data;
                renderBooks();
            }
        }
    
        function renderBooks() {
            const grid = document.getElementById('bookGrid');
            const booksHtml = allBooks.map(book => {
                const isSelected = selectedIds.includes(book.id);
                return `
                    <div class="book-card group cursor-pointer ${isSelected ? 'selected' : ''}" onclick="handleBookClick('${book.id}')">
                   
                    <div class="book-cover aspect-[3/4] rounded-xl overflow-hidden shadow-lg mb-4 bg-slate-200 relative border-4 border-transparent">
                        <img src="${book.cover_url}" class="w-full h-full object-cover">
                        
                        ${!isSelectMode ? `
                            <button onclick="event.stopPropagation(); deleteBook('${book.id}')" class="absolute top-2 right-2 w-8 h-8 bg-rose-500/80 hover:bg-rose-600 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                                <i class="fa-solid fa-trash-can text-xs"></i>
                            </button>
                        ` : ''}

                        ${isSelectMode ? `
                            <div class="checkbox-wrapper absolute top-3 right-3 w-6 h-6 rounded-full border-2 border-white/50 bg-black/20 flex items-center justify-center">
                                <i class="fa-solid fa-check text-[10px] ${isSelected ? 'block' : 'hidden'}"></i>
                            </div>
                        ` : `
                            <div class="absolute inset-0 bg-blue-900/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <span class="bg-white/90 text-blue-600 px-4 py-2 rounded-full text-xs font-bold shadow-lg">è¿›å…¥é˜…è¯»</span>
                            </div>
                        `}
                    </div>
                        <div class="px-1 text-center lg:text-left">
                            <h4 class="font-bold text-slate-900 text-sm line-clamp-1">${book.title}</h4>
                            <p class="text-[11px] text-slate-400 mt-1">${book.author || 'æœªçŸ¥ä½œè€…'}</p>
                        </div>
                    </div>
                `;
            }).join('');
    
            const addBtnHtml = `
                <div onclick="showAddModal()" class="border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center text-slate-400 hover:border-blue-300 hover:text-blue-500 transition-all aspect-[3/4] cursor-pointer group">
                    <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center mb-2 group-hover:bg-blue-50 transition-colors">
                        <i class="fa-solid fa-plus text-lg"></i>
                    </div>
                    <span class="text-xs font-bold">æ·»åŠ æ–°ä¹¦</span>
                </div>
            `;
            grid.innerHTML = booksHtml + addBtnHtml;
        }
        
        function updateUploadProgress(percent, text) {
        const container = document.getElementById('progressContainer');
        const inner = document.getElementById('progressInner');
        const textEl = document.getElementById('progressText');
        const percentEl = document.getElementById('progressPercent');

        container.classList.remove('hidden');
        inner.style.width = percent + '%';
        if (text) textEl.innerText = text;
        percentEl.innerText = Math.round(percent) + '%';
    }
        // --- äº¤äº’é€»è¾‘ ---
        window.handleBookClick = function(id) {
            if (isSelectMode) {
                const index = selectedIds.indexOf(id);
                if (index > -1) selectedIds.splice(index, 1);
                else selectedIds.push(id);
                renderBooks();
                updateToolbar();
            } else {
                window.location.href = `é˜…è¯»è¯¦æƒ…é¡µ.html?id=${id}`;
            }
        };
    
        function updateToolbar() {
            const toolbar = document.getElementById('batchToolbar');
            document.getElementById('selectedCount').innerText = selectedIds.length;
            if (selectedIds.length > 0) toolbar.classList.remove('translate-y-full');
            else toolbar.classList.add('translate-y-full');
        }
    
        window.clearAllSelection = () => {
            selectedIds = [];
            renderBooks();
            updateToolbar();
        };
    
        window.confirmImport = () => {
            const selectedData = allBooks.filter(b => selectedIds.includes(b.id));
            localStorage.setItem('temp_selected_books', JSON.stringify(selectedData));
            window.location.href = 'æ–°å¢é¡¹ç›®.html';
        };
    
        // --- å¯¼å…¥åŠŸèƒ½é€»è¾‘ ---
        window.showAddModal = () => document.getElementById('addBookModal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('addBookModal').classList.add('hidden');
    
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileStatus').innerHTML = `<p class="text-blue-600 font-bold">${file.name}</p>`;
                document.getElementById('newTitle').value = file.name.replace(/\.[^/.]+$/, "");
            }
        });
    
        // è§£æ PDF å‡½æ•°
        // æ›¿æ¢åŸæœ‰çš„ parsePDF å‡½æ•°
        // ä¿®æ”¹åçš„ parsePDFï¼Œå¢åŠ ä¸Šä¼ åŠŸèƒ½
        async function parsePDF(file, bookId) {
            // --- æ–°å¢ï¼šä¸Šä¼ åŸæ–‡ä»¶åˆ° Storage ---
            const fileExt = file.name.split('.').pop();
            const fileName = `${bookId}_raw.${fileExt}`;
            const { data: uploadData, error: uploadError } = await supabase.storage
                .from('book-files') // ğŸ‘ˆ è¯·ç¡®ä¿åœ¨ Supabase Storage åˆ›å»ºäº†åä¸º book-files çš„å…¬å¼€æ¡¶
                .upload(fileName, file);
            
            if (!uploadError) {
                const { data: { publicUrl } } = supabase.storage.from('book-files').getPublicUrl(fileName);
                window.currentFileUrl = publicUrl; // æš‚å­˜æ–‡ä»¶é“¾æ¥
            }

            // --- åŸæœ‰çš„è§£æå›¾ç‰‡é€»è¾‘ä¿æŒä¸å˜ ---
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let pages = [];
            window.currentPdfCover = null; 

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.5 }); 
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport: viewport }).promise;
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                
                if (i === 1) {
                    const thumbViewport = page.getViewport({ scale: 0.5 });
                    const thumbCanvas = document.createElement('canvas');
                    thumbCanvas.width = thumbViewport.width;
                    thumbCanvas.height = thumbViewport.height;
                    const thumbCtx = thumbCanvas.getContext('2d');
                    await page.render({ canvasContext: thumbCtx, viewport: thumbViewport }).promise;
                    window.currentPdfCover = thumbCanvas.toDataURL('image/jpeg', 0.6);
                }

                const pageHtml = `<div class="pdf-page-container"><img src="${imgData}" style="width:100%; height:auto;"></div>`;
                pages.push(pageHtml);
            }
            return pages;
        }
        
    
        // è§£æ TXT å‡½æ•°
        async function parseTXT(file) {
            const text = await file.text();
            const chunkSize = 1500; // æ¯é¡µå­—æ•°
            let pages = [];
            for (let i = 0; i < text.length; i += chunkSize) {
                pages.push(text.substring(i, i + chunkSize));
            }
            return pages;
        }
        // æ–°å¢ï¼šEPUB è§£æå‡½æ•°
        async function parseEPUB(file) {
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async (e) => {
                    try {
                        const book = ePub(e.target.result);
                        await book.ready;
                        // å°è¯•æå–å°é¢å›¾ URL
                        const coverUrl = await book.coverUrl();
                        if (coverUrl) {
                            // å¦‚æœæ‰¾åˆ°äº†å°é¢ï¼ŒæŠŠå®ƒä¸´æ—¶å­˜èµ·æ¥ï¼Œç¨åå­˜å…¥æ•°æ®åº“
                            window.currentEpubCover = coverUrl;
                        }
                        // è·å–ä¹¦ç±çš„æ‰€æœ‰ç« èŠ‚
                        const spine = book.spine;
                        let pages = [];

                        // éå†æ¯ä¸€ä¸ªç« èŠ‚è¿›è¡ŒæŠ“å–
                        for (const item of spine.items) {
                            const doc = await item.load(book.load.bind(book));
                            // æå–ç« èŠ‚é‡Œçš„çº¯æ–‡å­—ï¼ˆå»æ‰HTMLæ ‡ç­¾ï¼Œé˜²æ­¢æ ·å¼å†²çªï¼‰
                            const text = doc.body.innerText || doc.body.textContent;
                            
                            if (text && text.trim().length > 20) {
                                // å¦‚æœç« èŠ‚å¾ˆé•¿ï¼Œå†æŒ‰ 1500 å­—åˆ‡ä¸€ä¸‹ï¼Œé˜²æ­¢é¡µé¢å¤ªé•¿
                                const chunkSize = 1500;
                                for (let i = 0; i < text.length; i += chunkSize) {
                                    pages.push(text.substring(i, i + chunkSize));
                                }
                            }
                            item.unload();
                        }
                        resolve(pages);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }
    
        // ä¸Šä¼ æ ¸å¿ƒé€»è¾‘
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const title = document.getElementById('newTitle').value.trim();
            const author = document.getElementById('newAuthor').value.trim() || 'ä½šå';
            const file = document.getElementById('fileInput').files[0];
            
            if (!title || !file) return alert("è¯·å®Œæ•´å¡«å†™ä¿¡æ¯");
            
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.innerText = "ä¸Šä¼ ä¸­..."; 
            btn.classList.add('bg-slate-400', 'cursor-not-allowed'); // å¢åŠ è§†è§‰åé¦ˆ btn.innerText = "æ­£åœ¨è§£æå¹¶å­˜å…¥æ•°æ®åº“...";
    
            try {
                const bookId = 'book_' + Date.now();
                let pagesData = [];
                const ext = file.name.split('.').pop().toLowerCase();
                // 1. å¼€å§‹è§£æé˜¶æ®µ
                updateUploadProgress(5, "æ­£åœ¨åˆå§‹åŒ–è§£æå™¨...");

                if (ext === 'pdf') {
                    // æ³¨æ„ï¼šå¦‚æœä½ æƒ³åœ¨ parsePDF å†…éƒ¨æ˜¾ç¤ºæ›´ç»†çš„è¿›åº¦ï¼Œ
                    // éœ€è¦æŠŠ updateUploadProgress ä¼ å…¥ parsePDF å‡½æ•°ï¼Œè¿™é‡Œç®€å•å¤„ç†
                    pagesData = await parsePDF(file, bookId); 
                } else if (ext === 'txt') {
                    pagesData = await parseTXT(file);
                } else if (ext === 'epub') {
                    pagesData = await parseEPUB(file);
                } else {
                         throw new Error("ç›®å‰æ”¯æŒ PDF, TXT å’Œ EPUB æ ¼å¼");

                updateUploadProgress(40, "è§£æå®Œæˆï¼Œå‡†å¤‡å­˜å…¥æ•°æ®åº“...");

                // 2. å­˜å…¥ä¹¦ç±ä¸»è¡¨
                const { error: err1 } = await supabase.from('books').insert([{
                    id: bookId,
                    title: title,
                    author: author,
                    total_pages: pagesData.length,
                    cover_url: window.currentPdfCover || 'https://images.unsplash.com/photo-1543005139-059e15147552?w=400',
                    file_url: window.currentFileUrl
                }]);
                if (err1) throw err1;

                // 3. åˆ†æ‰¹å­˜å…¥å†…å®¹è¡¨ (è¿™é‡Œæ˜¯è¿›åº¦æ›´æ–°æœ€æ˜æ˜¾çš„åœ°æ–¹)
                const batchSize = 50;
                const totalBatches = Math.ceil(pagesData.length / batchSize);

                for (let i = 0; i < pagesData.length; i += batchSize) {
                    const currentBatchIndex = Math.floor(i / batchSize) + 1;
                    const batch = pagesData.slice(i, i + batchSize).map((text, index) => ({
                        book_id: bookId,
                        page_number: Number(i + index + 1),
                        content: text
                    }));

                    const { error: err2 } = await supabase.from('book_contents').insert(batch);
                    if (err2) throw err2;

                    // è®¡ç®—è¿›åº¦ï¼šä» 40% åˆ° 95% ä¹‹é—´åˆ†é…ç»™æ•°æ®åº“ä¸Šä¼ 
                    const dbProgress = 40 + (currentBatchIndex / totalBatches) * 55;
                    updateUploadProgress(dbProgress, `æ­£åœ¨åŒæ­¥æ•°æ® (ç¬¬ ${currentBatchIndex}/${totalBatches} ç»„)...`);
                }

                updateUploadProgress(100, "å…¨éƒ¨å®Œæˆï¼å³å°†åˆ·æ–°...");

                // å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ° 100%
                setTimeout(() => location.reload(), 800);
    
                // // 1. æ ¹æ®ç±»å‹è§£æå†…å®¹
                // // 1. æ ¹æ®ç±»å‹è§£æå†…å®¹
                // if (ext === 'pdf') {
                //     pagesData = await parsePDF(file, bookId); // ä¼ å…¥ bookId ç”¨äºæ–‡ä»¶å‘½å
                // } else if (ext === 'txt') {
                //     pagesData = await parseTXT(file);
                // } else if (ext === 'epub') {
                //     // æ–°å¢ï¼šè¯†åˆ« epub åç¼€
                //     pagesData = await parseEPUB(file);
                // } else {
                //     throw new Error("ç›®å‰æ”¯æŒ PDF, TXT å’Œ EPUB æ ¼å¼");
                // }
    
               
            } catch (err) {
                console.error(err);
                alert("å¯¼å…¥å¤±è´¥: " + err.message);
            } finally {
                btn.disabled = false; btn.innerText = "å¼€å§‹è§£æ";
            }
        });
    
        initUI();
        fetchBooks();
                window.deleteBook = async function(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦åŠå…¶æ‰€æœ‰é˜…è¯»å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
            
            try {
                // 1. åˆ é™¤å†…å®¹è¡¨é‡Œçš„æ•°æ®
                await supabase.from('book_contents').delete().eq('book_id', id);
                // 2. åˆ é™¤ä¹¦ç±ä¸»è¡¨é‡Œçš„æ•°æ®
                await supabase.from('books').delete().eq('id', id);
                
                alert('åˆ é™¤æˆåŠŸ');
                fetchBooks(); // åˆ·æ–°åˆ—è¡¨
            } catch (err) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + err.message);
            }
        };
    </script>
</body>
</html>