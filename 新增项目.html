<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知阅 - 新增阅读项目</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', "Microsoft YaHei", sans-serif; background-color: #f8fafc; }
        .sidebar-active { background-color: #ebf5ff; border-right: 4px solid #3b82f6; color: #1e40af; }
        .color-btn-active { border-color: #2563eb !important; background-color: #eff6ff !important; color: #2563eb !important; }
    </style>
</head>
<body class="flex min-h-screen text-slate-700">

    <aside class="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col sticky top-0 h-screen shrink-0">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-lg">知</div>
            <span class="text-xl font-bold text-slate-800">知阅</span>
        </div>
        <nav class="flex-1 px-4 space-y-1">
            <a href="strict-merge-dashboard.html" class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-md transition-all">
                <i class="fa-solid fa-house w-5"></i><span class="text-sm">首页仪表盘</span>
            </a>
            <a href="阅读目标列表页.html" class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-md transition-all">
                <i class="fa-solid fa-bullseye w-5"></i><span class="text-sm">阅读目标</span>
            </a>
            <a href="阅读项目列表页.html" class="sidebar-active flex items-center gap-3 px-4 py-3 rounded-md transition-all">
                <i class="fa-regular fa-folder w-5"></i><span class="font-medium text-sm">阅读项目</span>
            </a>
            <a href="我的书架.html" class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-md transition-all">
                <i class="fa-solid fa-book-open w-5"></i><span class="text-sm">我的书架</span>
            </a>
            <a href="读书笔记列表页.html" class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-md transition-all">
                <i class="fa-solid fa-pen-to-square w-5"></i><span class="text-sm">读书笔记</span>
            </a>
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto">
        <div class="max-w-3xl mx-auto p-6 md:p-8 pb-24 md:pb-10">
            <header class="flex items-center gap-4 mb-8">
                <a href="阅读项目列表页.html" class="w-9 h-9 border border-slate-200 rounded-lg flex items-center justify-center hover:bg-white transition-colors">
                    <i class="fa-solid fa-arrow-left text-slate-400"></i>
                </a>
                <h1 class="text-xl font-bold text-slate-800">新增阅读项目</h1>
            </header>

            <div class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm space-y-8">
                <div class="space-y-6">
                    <div class="space-y-3">
                        <label class="text-sm font-bold text-slate-700">项目图标与颜色</label>
                        <div class="flex gap-3" id="colorPicker">
                            <button class="color-btn color-btn-active w-12 h-12 rounded-xl border-2 border-slate-100 bg-white text-slate-300 flex items-center justify-center transition-all" data-color="blue" onclick="selectColor(this)">
                                <i class="fa-solid fa-book-open"></i>
                            </button>
                            <button class="color-btn w-12 h-12 rounded-xl border-2 border-slate-100 bg-white text-slate-300 flex items-center justify-center transition-all" data-color="purple" onclick="selectColor(this)">
                                <i class="fa-solid fa-book-open"></i>
                            </button>
                            <button class="color-btn w-12 h-12 rounded-xl border-2 border-slate-100 bg-white text-slate-300 flex items-center justify-center transition-all" data-color="emerald" onclick="selectColor(this)">
                                <i class="fa-solid fa-book-open"></i>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-700">项目名称 <span class="text-rose-500">*</span></label>
                        <input id="projectTitle" type="text" placeholder="例如：深度学习进阶" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="space-y-3">
                        <label class="text-sm font-bold text-slate-700">关联书籍</label>
                        <div class="relative mb-4">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" placeholder="搜索并添加书籍到此项目..." class="w-full pl-11 pr-4 py-3 border border-slate-200 rounded-xl bg-slate-50/50">
                        </div>
                        
                        <div id="selectedBooks" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <button onclick="window.location.href='浏览书架.html?mode=select'" class="flex items-center justify-center gap-2 p-3 border-2 border-dashed border-slate-100 rounded-xl text-slate-300 hover:border-blue-200 hover:text-blue-400 transition-all text-sm font-medium">
                                <i class="fa-solid fa-plus"></i> 浏览书架
                            </button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-700">项目描述</label>
                        <textarea id="projectDesc" rows="3" placeholder="描述这个项目涵盖的书籍范畴..." class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                    </div>
                </div>

                <div class="pt-6 border-t border-slate-100 flex gap-3">
                    <a href="阅读项目列表页.html" class="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl text-center">取消</a>
                    <button id="submitBtn" onclick="createAndReturn()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition-all">创建并返回</button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { supabase } from './supabase-config.js';
        window.supabase = supabase; // 暴露给全局函数使用

        let selectedColorName = 'blue';

        // 颜色选择
        window.selectColor = function(btn) {
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('color-btn-active'));
            btn.classList.add('color-btn-active');
            selectedColorName = btn.getAttribute('data-color');
        };

        // 移除书籍
        window.removeBook = function(bookId) {
            const el = document.querySelector(`[data-book-id="${bookId}"]`);
            if (el) {
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 300);
            }
        };

        // --- 自动接收从“浏览书架”导入的书籍 ---
        document.addEventListener('DOMContentLoaded', () => {
            const rawData = localStorage.getItem('temp_selected_books');
            if (rawData) {
                const importedBooks = JSON.parse(rawData);
                const container = document.getElementById('selectedBooks');
                const addBtn = container.querySelector('button'); 

                importedBooks.forEach(book => {
                    if (document.querySelector(`[data-book-id="${book.id}"]`)) return;

                    const html = `
                        <div class="flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-xl shadow-sm group transition-all" data-book-id="${book.id}">
                            <div class="w-10 h-14 bg-slate-200 rounded shadow-sm overflow-hidden flex-shrink-0">
                                <img src="${book.cover_url}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/100x140?text=No+Cover'">
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-bold text-slate-800 truncate">${book.title}</p>
                                <p class="text-[10px] text-slate-400 truncate">${book.author || '未知作者'}</p>
                            </div>
                            <button onclick="removeBook('${book.id}')" class="p-1.5 text-slate-300 hover:text-rose-500 transition-all">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>`;
                    addBtn.insertAdjacentHTML('beforebegin', html);
                });
                localStorage.removeItem('temp_selected_books');
            }
        });

        // 核心提交逻辑
        window.createAndReturn = async function() {
            // 1. 获取输入值
            const project_name = document.getElementById('projectTitle').value.trim();
            const description = document.getElementById('projectDesc').value.trim();
            const submitBtn = document.getElementById('submitBtn');

            if (!project_name) {
                alert('项目名称是必填的哦');
                return;
            }

            // 2. 获取当前用户
            const { data: { user }, error: authError } = await window.supabase.auth.getUser();
            if (authError || !user) {
                alert("登录状态已失效，请重新登录");
                window.location.href = 'login.html';
                return;
            }

            // 禁用按钮
            submitBtn.disabled = true;
            submitBtn.innerText = "保存中...";

            // 3. 抓取书籍数据
            const bookEls = document.querySelectorAll('#selectedBooks [data-book-id]');
            const booksData = Array.from(bookEls).map(el => ({
                id: el.getAttribute('data-book-id'),
                title: el.querySelector('p.font-bold').innerText,
                author: el.querySelector('p.text-slate-400').innerText,
                cover_url: el.querySelector('img').src
            }));

            try {
                // 4. 插入项目
                const { data: pData, error: pErr } = await window.supabase
                    .from('projects')
                    .insert([{
                        project_name: project_name,
                        description: description,
                        status: '进行中',
                        cover_url: `https://via.placeholder.com/150/${selectedColorName}`,
                        user_id: user.id
                    }])
                    .select();

                if (pErr) throw pErr;
                const newProjectId = pData[0].id;

                // 5. 处理书籍关联
                if (booksData.length > 0) {
                    // 存入书籍库 (使用 upsert 防止重复)
                    const { error: bErr } = await window.supabase.from('books').upsert(booksData);
                    if (bErr) throw bErr;

                    // 建立关联
                    const relations = booksData.map(b => ({
                        project_id: newProjectId,
                        book_id: b.id
                    }));
                    const { error: rErr } = await window.supabase.from('project_books').insert(relations);
                    if (rErr) throw rErr;
                }

                showToast('项目创建成功！');
                setTimeout(() => window.location.href = '阅读项目列表页.html', 1000);

            } catch (err) {
                console.error(err);
                alert('保存失败: ' + err.message);
                submitBtn.disabled = false;
                submitBtn.innerText = "创建并返回";
            }
        };

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-emerald-500 text-white px-6 py-3 rounded-xl shadow-lg z-50 flex items-center gap-2';
            toast.innerHTML = `<i class="fa-solid fa-check-circle"></i><span>${message}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }
    </script>
</body>
</html>